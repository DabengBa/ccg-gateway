---
# Docker 部署（公网）+ 密码鉴权 PRD

2026-01-18

> 本文档既是「需求澄清」也是「Brainstorming 的落地载体」。
> 目标是把模糊想法通过结构化提问收敛成：可交付的 MVP、清晰边界、可验证验收。

## 0. 决策与未决问题

### 0.1 决策记录（Decisions）

- D1：本次目标是「Web 服务部署」，不包含桌面托盘/pywebview 模式。
- D2：部署目标为公网可访问服务器，必须加入鉴权与基础安全加固。
- D3（待确认）：Docker 部署形态优先采用「前后端分容器 + Nginx 反代」（改动最小）。

### 0.2 假设（Assumptions）

- A1：公网访问对象包含 Web UI（浏览器）以及网关转发能力（供 CLI/客户端调用）。
- A2：现有后端 FastAPI 没有内置鉴权（目前确实无），需要新增。
- A3：服务商 Provider 的 api_key 等敏感信息会存储在 SQLite（现状如此），必须避免被未授权访问。

### 0.3 未决问题（Open Questions）

- Q1：鉴权覆盖范围？
  - 选项 A：只保护 Web UI /admin（不推荐，网关转发口仍可被滥用）。
  - 选项 B：保护 /admin/v1/* + 网关转发 /{path:path}（推荐）。
  - 负责人：产品/负责人；截止：2026-01-19。
- Q2：鉴权方式选择？
  - 选项 A：单个共享 Token（MVP，最快）。
  - 选项 B：多用户账号体系（需要用户表、密码哈希、会话/JWT、权限）。
  - 负责人：产品/负责人；截止：2026-01-19。
- Q3：对外开放端口策略？
  - 选项 A：只暴露 80/443（Nginx），后端 7788 仅内网。
  - 选项 B：额外暴露 7788 给公网直连（强依赖应用层鉴权 + 限流）。
  - 负责人：运维/负责人；截止：2026-01-19。

## 1. 一页摘要

- 目标（Outcome）：
  - 为 CCG Gateway 提供可在公网服务器部署的 Docker 方案（可一键启动），并通过鉴权阻止未授权访问/滥用。
- 核心用户（Primary user）：
  - 自建服务的个人/小团队运维者；需要通过互联网访问 Web UI 与网关转发能力。
- MVP（1 句话闭环）：
  - 通过 docker compose 启动后，用户可以在浏览器打开 UI，且所有管理接口与转发接口均需要携带访问凭证才能使用。
- 明确不做（Not in scope）：
  - 桌面端打包（PyInstaller/pywebview）容器化；多租户/多用户体系（除非后续决策选定）。
- 验收方式（How to verify）：
  - 按第 12 节用例执行：未携带凭证访问应被拒绝；携带正确凭证可正常使用 UI/API/转发；容器重启后数据仍在。

## 2. 背景与目标（Why）

- 现状/痛点（证据）：
  - 项目目前提供本地开发脚本（`start-backend.bat`/`start-frontend.bat`），缺少面向服务器的容器部署形态。
  - 后端存在管理接口 `/admin/v1/*` 且无鉴权；同时存在全路径转发入口 `/{path:path}`，公网暴露风险极高。
- 要达成的业务结果：
  - 在公网服务器上稳定运行，并且默认安全（最少暴露面，具备鉴权、HTTPS 支持建议）。
- 成功指标（Metrics）：
  - 30 分钟内可完成部署（提供 compose 与配置说明）。
  - 未授权请求 100% 被拦截（至少覆盖管理 API 与转发入口）。
  - 数据可持久化：容器重启后配置、日志、备份不丢失。

## 3. 用户与场景（Who/When）

- 用户画像/角色：
  - 管理员/部署者：拥有服务器权限，负责部署、升级、备份。
  - 使用者：通过浏览器使用 Web UI；通过 CLI/脚本调用网关转发。
- 触发时机与频率：
  - 初次部署 1 次；后续升级按发布节奏。
  - 日常使用高频（转发请求）；配置变更低频。
- 典型场景：
  1) 管理员在服务器上启动 compose，通过域名访问 UI 配置 Provider。
  2) CLI/脚本通过公网域名访问网关端口进行转发。

## 4. 需求范围与交付物（What）

### 4.1 MVP（必须交付）

- [ ] 提供可运行的 Docker 部署文件（最少包含 Dockerfile + docker-compose.yml），可以在干净服务器上启动。
  - 验收：执行 `docker compose up -d` 后容器全部 healthy，UI 可访问。
- [ ] 后端容器启动时绑定 `0.0.0.0`，可被反代/外部访问。
  - 验收：容器内 `uvicorn` 监听非 127.0.0.1；Nginx 反代可访问 `/health` 与 `/admin/v1/*`。
- [ ] 数据持久化（SQLite + backups + 可选日志文件）。
  - 验收：修改配置后重启容器，配置仍存在；导出备份后文件仍在挂载卷中。
- [ ] 鉴权（MVP）
  - [ ] 为管理接口与转发入口增加访问控制（默认开启）。
    - 验收：未携带凭证访问 `/admin/v1/*` 和 `/{path:path}` 返回 401/403。
  - [ ] 提供一种最小凭证形态（默认建议：共享 Token）。
    - 验收：携带正确 token 后可正常访问；token 错误被拒绝。
- [ ] 部署文档（放到 `./docs` 下，引用本 PRD 结论）
  - 验收：文档包含：环境要求、配置项、启动命令、升级/备份/恢复步骤。

### 4.2 边界（明确不做）

- 不做桌面 GUI 容器化。
- 不做多用户/权限系统（除非 Q2 选择多用户）。
- 不做复杂的证书自动签发逻辑（可提供 Nginx 配置与建议，证书获取交给运维工具链）。

### 4.3 非功能性需求（NFR）

- 性能：
  - MVP 不做极限压测；至少确保常规请求不会因鉴权引入明显延迟（< 5ms 级别）。
- 可靠性：
  - 容器可重启；健康检查可用（使用 `/health`）。
- 安全/隐私：
  - 需要鉴权；敏感信息不得出现在 debug 日志中（若开启 debug log）。
  - 默认不建议直接暴露后端 7788 到公网，推荐经由反代/防火墙策略控制。
- 可用性：
  - 部署失败时给出明确错误（文档/日志可定位）。

## 5. 端到端流程（Happy Path）

1) 管理员准备服务器：安装 Docker / Docker Compose。
2) 管理员配置环境变量（例如 `.env`）：域名、端口、鉴权 token、数据卷路径。
3) 执行 `docker compose up -d`。
4) 浏览器访问 `https://<domain>/` 打开 UI。
5) UI 调用 `/admin/v1/*` 完成 Provider 配置。
6) CLI/客户端向 `https://<domain>/` 或 `https://<domain>:<gateway_port>/`（取决于端口策略）发起请求，携带 token，通过网关转发到上游。

## 6. 交互与体验（UX）

- MVP 尽量不改 UI；鉴权失败时，前端应显示明确错误（现有 axios 拦截器会弹 toast）。
- 若采用 Header token：
  - 浏览器侧需要提供输入/保存 token 的方式（待定：本次是否做 UI 支持）。

## 7. 数据、接口与输出（Deliverables）

- 输入：
  - `.env`/环境变量：网关端口、日志开关、鉴权 token 等。
- 输出：
  - Docker 镜像/compose 服务；运行中生成的数据：`data/ccg_gateway.db`、`data/backups/*`、`data/app.log`（若启用）。
- 接口：
  - `/health`：健康检查（无需鉴权 or 可选放行）。
  - `/admin/v1/*`：管理 API（需要鉴权）。
  - `/{path:path}`：转发入口（需要鉴权）。

## 8. 异常与极端场景（Edge Cases）

1) 未携带 token 访问
   - 用户看到：401/403；UI 提示“未授权/鉴权失败”。
   - 系统恢复：用户配置正确 token 后重试。
2) token 泄露
   - 用户看到：可能被滥用。
   - 缓解：支持更换 token（重启生效或热更新）；建议配合限流/IP 白名单。
3) 容器重启后数据丢失
   - 原因：未挂载 volume。
   - 缓解：compose 默认挂载 `data/` 并在文档强调。
4) 上游 Provider 不可用
   - 用户看到：网关返回 502/错误；系统按现有故障转移逻辑处理。
5) Debug 日志泄露敏感 header/body
   - 缓解：在日志打印前进行脱敏（至少 Authorization/x-goog-api-key 等）。

## 9. 默认策略与业务规则（Defaults/Rules）

- 缺省值：
  - `GATEWAY_PORT=7788`（现有默认）。
  - 鉴权默认开启（除非显式关闭）。
- 权限与可见性：
  - 未授权用户不可访问任何管理接口与转发入口。
- 幂等/重复提交：
  - 配置更新按现有 API 行为；鉴权不改变业务幂等语义。
- 重试/超时：
  - 不新增重试策略；沿用现有超时配置项。

## 10. 方案与取舍（Options & Decisions）

### 10.1 可选方案对比

| 方案 | 优点 | 缺点 | 选择/不选原因 |
|---|---|---|---|
| A：前后端分容器 + Nginx 反代 | 不改后端静态服务逻辑；结构清晰；易加 HTTPS/限流 | 多一个容器与配置文件 | 推荐优先选择（D3） |
| B：单容器（后端同时 serve dist） | 部署组件更少 | 需要改 `get_frontend_dist()` 逻辑；耦合更强 | 次选 |
| 鉴权：Nginx basic auth | 实现快 | 不适合 CLI/程序化调用；粒度粗 | 不作为唯一鉴权 |
| 鉴权：应用层 token（Header） | 兼容 CLI；粒度可控 | 需要改后端；前端可能需支持输入 token | 推荐作为核心鉴权 |

### 10.2 决策与假设

- 决策（D）：见 0.1。
- 假设（A）：见 0.2。

## 11. 约束、依赖与风险（Constraints）

- 约束：
  - 项目后端目前默认从根目录 `.env` 读取（容器内路径需要一致或改为环境变量注入）。
  - 当前后端在非打包模式不服务前端静态资源（决定了部署方案倾向分容器）。
- 外部依赖：
  - Docker / Docker Compose；若启用 HTTPS，依赖证书颁发与域名解析。
- 风险与缓解：
  - R1：公网暴露导致滥用/数据泄露 → 必须鉴权 + 建议限流/防火墙。
  - R2：日志泄露 token/provider key → 必须在 debug log 做脱敏。

## 12. 验收与完成标准（Acceptance / DoD）

1) 用例：未授权访问被拒绝（管理 API）
   - 前置：服务已通过 compose 启动；鉴权开启。
   - 步骤：curl 访问 `GET /admin/v1/settings`（不带 token）。
   - 预期：返回 401/403。

2) 用例：授权访问成功（管理 API）
   - 前置：已配置正确 token。
   - 步骤：curl 访问 `GET /admin/v1/settings`（携带 token）。
   - 预期：返回 200 且有 JSON body。

3) 用例：未授权访问被拒绝（转发入口）
   - 前置：同上。
   - 步骤：向任意 `/{path:path}` 发请求（不带 token）。
   - 预期：返回 401/403。

4) 用例：数据持久化
   - 前置：配置了 volume 挂载。
   - 步骤：在 UI 添加一个 provider；重启容器。
   - 预期：provider 配置仍存在；`data/ccg_gateway.db` 文件仍存在。

5) 用例：健康检查
   - 前置：服务启动。
   - 步骤：访问 `/health`。
   - 预期：返回 `{"status":"ok"}`（是否需要鉴权由最终决策决定）。
